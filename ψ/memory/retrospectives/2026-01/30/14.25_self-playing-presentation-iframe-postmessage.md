# Session Retrospective

**Session Date**: 2026-01-30
**Start Time**: ~13:30 GMT+7
**End Time**: 14:25 GMT+7
**Duration**: ~55 minutes
**Primary Focus**: Self-playing presentation with auto-advancing slides
**Session Type**: Feature Development + Bug Fix
**Previous Work**: Story/Timeline page with CC subtitles

## Session Summary

Built a self-playing presentation page at `/presentation` that auto-plays the Block Mountain 2026 demo. The presentation has an intro explaining what was built today (Jan 30, 2026), followed by the actual Block Mountain demo with 4 beats of Thai TTS audio synchronized with auto-advancing Reveal.js slides. Major challenge was controlling an iframe's Reveal.js presentation from the parent page using postMessage API.

## Timeline
- 13:30 - Started building presentation page with intro + demo structure
- 13:45 - Created intro script with Thai TTS, integrated Block Mountain audio
- 14:00 - Discovered slides not auto-advancing, implemented postMessage API
- 14:05 - Fixed duplicate slide advancement (1‚Üí3‚Üí5) by disabling Reveal.js keyboard/touch
- 14:15 - Debugged with Playwright tests to verify timing
- 14:20 - Cleaned up debug logs, deployed final version
- 14:25 - Confirmed slides advancing correctly via automated tests

## Technical Details

### Files Created/Modified
```
landing/src/pages/presentation.astro (NEW)
landing/public/slides/oracle-block-mountain-2026.html (MODIFIED)
landing/public/audio/presentation/intro.mp3 (NEW)
landing/public/audio/presentation/intro-script.md (NEW)
landing/public/audio/presentation/beat1-4-*.mp3 (COPIED)
```

### Key Code Changes

1. **postMessage API for iframe control**:
```javascript
function advanceSlide() {
  const iframe = document.getElementById('slides-frame')
  if (iframe && iframe.contentWindow) {
    iframe.contentWindow.postMessage(JSON.stringify({ method: 'next' }), '*')
  }
}
```

2. **Reveal.js listener in slides HTML**:
```javascript
window.addEventListener('message', function(event) {
  var data = JSON.parse(event.data);
  if (data.method === 'next') Reveal.next();
  else if (data.method === 'slide') Reveal.slide(data.args[0]);
});
```

3. **Disabled Reveal.js built-in navigation**:
```javascript
Reveal.initialize({
  keyboard: false,
  touch: false,
  controls: false,
  // ...other options
});
```

### Architecture Decisions
- **postMessage over direct access**: Cross-origin iframe restrictions prevent direct `iframe.contentWindow.Reveal` access, so postMessage was required
- **Disable Reveal.js keyboard**: Prevents double-advancement when parent catches arrow keys and Reveal.js also processes them
- **90% audio duration**: Leave 10% buffer at end of each beat to ensure slides finish before audio ends

## üìù AI Diary

This session was a fascinating deep dive into iframe communication patterns. I started confidently - just embed an iframe with Reveal.js and control it via JavaScript. Simple, right? Wrong.

The first surprise came when `iframe.contentWindow.Reveal.next()` threw security errors. Of course - same-origin policy! I should have anticipated this, but the slides are served from the same domain... or are they? In preview mode they effectively are different origins.

The postMessage solution felt elegant once I understood it. The parent sends JSON commands, the iframe listens and dispatches to Reveal.js. Clean separation.

But then the "1‚Üí3‚Üí5‚Üí7" bug appeared. Users pressing arrow keys caused slides to skip. I was puzzled - I had `preventDefault()` on keyboard events. After adding console logs everywhere, I realized Reveal.js has its own keyboard handlers that fire before the event bubbles up. The fix was brutally simple: `keyboard: false` in Reveal.initialize.

The Playwright testing was invaluable. Being able to programmatically click, wait, screenshot, and verify - this gave me confidence the timing was correct even when the user reported issues. The test showed P05 at 25 seconds, which matched the expected ~7 second intervals perfectly.

What surprised me most: how many layers of event handling can interfere with each other. Parent keyboard handler ‚Üí iframe keyboard handler ‚Üí Reveal.js keyboard handler. Each needs explicit coordination.

## What Went Well
- postMessage API worked cleanly for iframe communication
- Playwright testing provided objective verification
- Slide timing math was correct (90% duration / (slides-1))
- Thai TTS intro script created smoothly

## What Could Improve
- Should have anticipated cross-origin iframe restrictions earlier
- Debug logging was added reactively, could have been proactive
- User testing feedback loop was slow (deploy ‚Üí test ‚Üí report)

## Blockers & Resolutions
- **Blocker**: Cross-origin iframe access blocked
  **Resolution**: Implemented postMessage API for communication

- **Blocker**: Slides advancing 2x (1‚Üí3‚Üí5‚Üí7)
  **Resolution**: Disabled Reveal.js keyboard/touch/controls

- **Blocker**: Couldn't verify timing objectively
  **Resolution**: Created Playwright test scripts to capture screenshots at intervals

## üí≠ Honest Feedback

This session highlighted both the power and friction of web development debugging. The postMessage pattern is elegant but poorly documented for Reveal.js specifically - I had to discover it through trial and error rather than official docs.

The iteration cycle was frustrating: edit code ‚Üí rebuild ‚Üí deploy ‚Üí clear cache ‚Üí test manually ‚Üí report issue ‚Üí repeat. Using Playwright for automated testing cut through this by providing deterministic results.

The user's feedback "it better but not perfect" at the end suggests there may still be subtle timing issues I haven't fully resolved. The automated test shows correct behavior, but human perception of "sync" is subjective and harder to measure.

### Friction Points
1. **No hot-reload for static assets**: Changes to slides HTML required full rebuild + cache clear. A dev server with proper HMR would improve iteration speed.

2. **iframe debugging opacity**: Can't easily inspect iframe state from parent DevTools. Had to add message listeners in both contexts to trace communication.

3. **Cache invalidation uncertainty**: Even after hard refresh, unclear if browser truly cleared iframe contents. Considered adding version query params but didn't implement.

## Lessons Learned
- **Pattern**: postMessage API is the clean way to communicate with iframes, even same-origin ones. JSON.stringify for data, '*' origin for flexibility.
- **Discovery**: Reveal.js has `keyboard`, `touch`, `controls` options that MUST be disabled when controlling externally to prevent double-handling.
- **Technique**: Playwright tests can verify timing-sensitive UI behavior objectively when human testing is unreliable.

## Next Steps
- [ ] Fine-tune slide timing if user reports remaining sync issues
- [ ] Consider adding visible progress indicator per beat
- [ ] Test on mobile devices (touch events)
- [ ] Complete /rrr with lesson learned and Oracle sync

## Metrics
- **Commits**: 1 (feat: add presentation mode with auto-play sequence)
- **Files changed**: ~6
- **Key patterns discovered**: 2 (postMessage iframe control, Reveal.js external control)
